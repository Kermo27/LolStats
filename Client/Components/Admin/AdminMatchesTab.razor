@using LolStatsTracker.Services.AdminService
@using LolStatsTracker.Shared.DTOs
@inject IAdminService AdminService
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudStack Spacing="4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudTextField @bind-Value="_searchTerm" Placeholder="Search by champion or mode..."
                      Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="SearchChanged"
                      Class="search-field" Style="max-width: 400px;" />
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.body2" Class="text-gray-400">
                Showing @(_matches?.Items.Count ?? 0) of @(_matches?.TotalCount ?? 0) matches
            </MudText>
        </MudStack>
    </MudStack>

    @if (_isLoading)
    {
        <MudSkeleton SkeletonType="SkeletonType.Rectangle" Height="400px" />
    }
    else if (_matches?.Items.Any() == true)
    {
        <MudTable Items="@_matches.Items" Hover="true" Striped="true" Dense="true"
                  Class="admin-table" Elevation="0">
            <HeaderContent>
                <MudTh>Date</MudTh>
                <MudTh>Champion</MudTh>
                <MudTh>Role</MudTh>
                <MudTh>Gamemode</MudTh>
                <MudTh>Result</MudTh>
                <MudTh>Profile</MudTh>
                <MudTh>User</MudTh>
                <MudTh>Action</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Date">@context.Date.ToString("dd.MM.yyyy HH:mm")</MudTd>
                <MudTd DataLabel="Champion">@context.Champion</MudTd>
                <MudTd DataLabel="Role">@context.Role</MudTd>
                <MudTd DataLabel="Gamemode">
                    <MudChip T="string" Size="Size.Small" Color="@GetGameModeColor(context.GameMode)">
                        @context.GameMode
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Result">
                    <MudChip T="string" Size="Size.Small" Color="@(context.Win ? Color.Success : Color.Error)">
                        @(context.Win ? "Win" : "Lose")
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Profile">
                    @if (context.ProfileName != null)
                    {
                        @($"{context.ProfileName}#{context.ProfileTag ?? "?"}")
                    }
                    else
                    {
                        <span>â€”</span>
                    }
                </MudTd>
                <MudTd DataLabel="User">@(context.Username ?? "-")</MudTd>
                <MudTd DataLabel="Action">
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                                   OnClick="@(() => ConfirmDelete(context))" 
                                   Title="Delete match" />
                </MudTd>
            </RowTemplate>
        </MudTable>
        
        <MudStack Row="true" Justify="Justify.Center" Class="mt-4">
            <MudPagination Count="@TotalPages" Selected="@_page" SelectedChanged="PageChanged"
                          Color="Color.Primary" ShowFirstButton="true" ShowLastButton="true" />
        </MudStack>
    }
    else
    {
        <MudAlert Severity="Severity.Info">No matches</MudAlert>
    }
</MudStack>

<style>
    .admin-table {
        background: rgba(30, 30, 40, 0.4);
        border-radius: 8px;
    }
    
    .search-field {
        background: rgba(40, 40, 55, 0.6);
        border-radius: 8px;
    }
</style>

@code {
    private PaginatedResponse<AdminMatchDto>? _matches;
    private bool _isLoading = true;
    private int _page = 1;
    private int _pageSize = 15;
    private string _searchTerm = "";
    
    private int TotalPages => _matches == null ? 1 : (int)Math.Ceiling((double)_matches.TotalCount / _pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadMatchesAsync();
    }

    private async Task LoadMatchesAsync()
    {
        _isLoading = true;
        _matches = await AdminService.GetMatchesAsync(_page, _pageSize, _searchTerm);
        _isLoading = false;
    }

    private async Task SearchChanged(string value)
    {
        _searchTerm = value;
        _page = 1;
        await LoadMatchesAsync();
    }

    private async Task PageChanged(int page)
    {
        _page = page;
        await LoadMatchesAsync();
    }

    private Color GetGameModeColor(string gameMode) => gameMode switch
    {
        "Ranked Solo" => Color.Primary,
        "Ranked Flex" => Color.Secondary,
        "Normal" => Color.Default,
        "ARAM" => Color.Info,
        _ => Color.Default
    };

    private async Task ConfirmDelete(AdminMatchDto match)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete this match ({match.Champion}, {match.Date:dd.MM.yyyy})?",
            yesText: "Delete",
            cancelText: "Cancel");
        
        if (result == true)
        {
            var success = await AdminService.DeleteMatchAsync(match.Id);
            if (success)
            {
                Snackbar.Add("Match deleted", Severity.Success);
                await LoadMatchesAsync();
            }
            else
            {
                Snackbar.Add("Failed to delete match", Severity.Error);
            }
        }
    }
}
