@using LolStatsTracker.Services.LeagueAssetsService
@using LolStatsTracker.Shared.Models
@inject ILeagueAssetsService LeagueAssetsService

<MudCard Class="mb-8 p-4 rounded-xl glass-card" Elevation="0">
    <MudCardContent>
        <div class="d-flex justify-space-between align-center mb-6">
            <MudText Typo="Typo.h5" Class="font-bold gradient-text">
                @(IsEditing ? "Edit Match" : "Add New Match")
            </MudText>
            @if(Model.Win) { <MudChip T="string" Class="victory-badge" Icon="@Icons.Material.Filled.EmojiEvents">Victory</MudChip> }
            else { <MudChip T="string" Class="defeat-badge" Icon="@Icons.Material.Filled.Close">Defeat</MudChip> }
        </div>

        <EditForm Model="@Model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            
            <MudGrid Spacing="3">
                
                <MudItem xs="12">
                    <MudSelect T="string" Label="Rola" @bind-Value="Model.Role" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem Value="@("Top")">Top Lane</MudSelectItem>
                        <MudSelectItem Value="@("Jungle")">Jungle</MudSelectItem>
                        <MudSelectItem Value="@("Mid")">Mid Lane</MudSelectItem>
                        <MudSelectItem Value="@("ADC")">ADC (Bot)</MudSelectItem>
                        <MudSelectItem Value="@("Support")">Support</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                     <div class="d-flex gap-3 align-center">
                        @if (!string.IsNullOrEmpty(Model.Champion)) {
                            <img src="@LeagueAssetsService.GetChampionIconUrl(Model.Champion)" height="56" width="56" style="border-radius: 12px; border: 2px solid var(--mud-palette-primary);" />
                        }
                        <MudAutocomplete T="string" @bind-Value="Model.Champion" Label="Your Champion" SearchFunc="SearchChampions" Variant="Variant.Outlined" Class="flex-grow-1">
                             <ItemTemplate Context="championName">
                                <MudStack Row="true" AlignItems="AlignItems.Center">
                                    <img src="@LeagueAssetsService.GetChampionIconUrl(championName)" height="32" width="32" style="border-radius: 50%;" />
                                    <MudText>@championName</MudText>
                                </MudStack>
                            </ItemTemplate>
                        </MudAutocomplete>
                     </div>
                </MudItem>

                <!-- Lane Partners - for all roles -->
                <MudItem xs="12" sm="4">
                    <MudAutocomplete T="string" @bind-Value="Model.LaneAlly" 
                                     Label="@GetLaneAllyLabel()" 
                                     SearchFunc="SearchChampions" 
                                     Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudAutocomplete T="string" @bind-Value="Model.LaneEnemy" 
                                     Label="@GetLaneEnemyLabel()" 
                                     SearchFunc="SearchChampions" 
                                     Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudAutocomplete T="string" @bind-Value="Model.LaneEnemyAlly" 
                                     Label="@GetLaneEnemyAllyLabel()" 
                                     SearchFunc="SearchChampions" 
                                     Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="4" sm="2"><MudNumericField @bind-Value="Model.Kills" Label="Kills" Variant="Variant.Outlined" HideSpinButtons="true" /></MudItem>
                <MudItem xs="4" sm="2"><MudNumericField @bind-Value="Model.Deaths" Label="Deaths" Variant="Variant.Outlined" HideSpinButtons="true" /></MudItem>
                <MudItem xs="4" sm="2"><MudNumericField @bind-Value="Model.Assists" Label="Assists" Variant="Variant.Outlined" HideSpinButtons="true" /></MudItem>
                <MudItem xs="6" sm="3"><MudNumericField @bind-Value="Model.Cs" Label="@(Model.Role == "Support" ? "Vision Score" : "CS")" Variant="Variant.Outlined" /></MudItem>
                <MudItem xs="6" sm="3"><MudNumericField @bind-Value="Model.GameLengthMinutes" Label="Minutes" Variant="Variant.Outlined" /></MudItem>

                <MudItem xs="12"><MudDivider Class="my-2"/><MudText Color="Color.Primary">RANKED DATA</MudText></MudItem>
                
                <MudItem xs="6" sm="3">
                    <MudSelect T="string" Label="Tier" @bind-Value="Model.CurrentTier" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem Value="@("Unranked")" />
                        <MudSelectItem Value="@("Iron")" />
                        <MudSelectItem Value="@("Bronze")" />
                        <MudSelectItem Value="@("Silver")" />
                        <MudSelectItem Value="@("Gold")" />
                        <MudSelectItem Value="@("Platinum")" />
                        <MudSelectItem Value="@("Emerald")" />
                        <MudSelectItem Value="@("Diamond")" />
                        <MudSelectItem Value="@("Master")" />
                    </MudSelect>
                </MudItem>
                <MudItem xs="6" sm="3">
                    <MudSelect T="int" Label="Div" @bind-Value="Model.CurrentDivision" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                        <MudSelectItem Value="1">I</MudSelectItem>
                        <MudSelectItem Value="2">II</MudSelectItem>
                        <MudSelectItem Value="3">III</MudSelectItem>
                        <MudSelectItem Value="4">IV</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="6" sm="6">
                    <MudNumericField @bind-Value="Model.CurrentLp" Label="LP After Match" Variant="Variant.Outlined" Min="0" Max="100" 
                                     HelperText="Your LP after this game" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudDatePicker Date="@Model.Date" DateChanged="@(val => Model.Date = val ?? DateTime.Now)" Label="Data" Variant="Variant.Outlined" />
                </MudItem>
                
                <MudItem xs="12" sm="6" Class="d-flex justify-center align-center">
                    <MudPaper Outlined="true" Class="px-4 py-2 d-flex align-center gap-4 rounded-lg" Style="@(Model.Win ? "border-color:var(--mud-palette-success)" : "border-color:var(--mud-palette-error)")">
                        <MudText Color="@(Model.Win ? Color.Default : Color.Error)">Defeat</MudText>
                        <MudSwitch @bind-Value="Model.Win" 
                                   Color="Color.Success" 
                                   Label="@(Model.Win ? "Victory" : "Defeat")" />
                        <MudText Color="@(Model.Win ? Color.Success : Color.Default)">Victory</MudText>
                    </MudPaper>
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="Model.Notes" 
                                  Label="Notes" 
                                  Placeholder="What did you learn? What could you improve?"
                                  Variant="Variant.Outlined" 
                                  Lines="2"
                                  HelperText="Optional reflection on this game" />
                </MudItem>

                <MudItem xs="12" Class="d-flex justify-end gap-2 mt-4">
                    @if (IsEditing) { <MudButton Variant="Variant.Outlined" OnClick="CancelEdit">Cancel</MudButton> }
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary">Save</MudButton>
                </MudItem>

            </MudGrid>
        </EditForm>
    </MudCardContent>
</MudCard>

@code {
    [Parameter] public MatchEntry Model { get; set; } = new();
    [Parameter] public bool IsEditing { get; set; }
    [Parameter] public EventCallback<MatchEntry> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LeagueAssetsService.InitializeAsync();
    }

    private async Task HandleSubmit() => await OnSave.InvokeAsync(Model);
    private async Task CancelEdit() => await OnCancel.InvokeAsync();
    
    private string GetLaneAllyLabel() => Model.Role switch
    {
        "Top" => "Allied Jungler",
        "Jungle" => "Allied Mid",
        "Mid" => "Allied Jungler",
        "ADC" => "Support",
        "Support" => "ADC",
        _ => "Lane Ally"
    };
    
    private string GetLaneEnemyLabel() => Model.Role switch
    {
        "Top" => "Enemy Top",
        "Jungle" => "Enemy Jungler",
        "Mid" => "Enemy Mid",
        "ADC" => "Enemy ADC",
        "Support" => "Enemy Support",
        _ => "Lane Enemy"
    };
    
    private string GetLaneEnemyAllyLabel() => Model.Role switch
    {
        "Top" => "Enemy Jungler",
        "Jungle" => "Enemy Mid",
        "Mid" => "Enemy Jungler",
        "ADC" => "Enemy Support",
        "Support" => "Enemy ADC",
        _ => "Lane Enemy Ally"
    };
    
    private Task<IEnumerable<string>> SearchChampions(string value, CancellationToken token)
    {
        var all = LeagueAssetsService.GetChampionNames();
        if (string.IsNullOrWhiteSpace(value)) return Task.FromResult(all.Take(10));
        return Task.FromResult(all.Where(x => x.Contains(value, StringComparison.InvariantCultureIgnoreCase)).Take(10));
    }
}