@using LolStatsTracker.Shared.Models
@using LolStatsTracker.Services.LeagueAssetsService
@inject ILeagueAssetsService LeagueAssetsService
@inject IDialogService DialogService

<MudTable Items="Matches" Hover="true" Bordered="false" Striped="true" Virtualize="true" Class="rounded-xl glass-card" Dense="true">
    <HeaderContent>
        <MudTh>Date</MudTh>
        <MudTh>Mode</MudTh>
        <MudTh>Role</MudTh> 
        <MudTh>Champion</MudTh>
        <MudTh>Info (Lane)</MudTh> 
        <MudTh>Division / LP</MudTh> 
        <MudTh>K/D/A</MudTh>
        <MudTh>CS</MudTh>
        <MudTh>Time</MudTh>
        <MudTh>Score</MudTh>
        <MudTh>W/L</MudTh>
        <MudTh><MudIcon Icon="@Icons.Material.Filled.Notes" Size="Size.Small" Title="Notes" /></MudTh>
        <MudTh>Actions</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Date">
            <MudText Typo="Typo.body2">@context.Date.ToString("dd-MM-yyyy")</MudText>
        </MudTd>

        <MudTd DataLabel="Mode">
            <MudChip T="string" Size="Size.Small" 
                     Color="@(context.GameMode.Contains("Ranked") ? Color.Primary : 
                              context.GameMode == "ARAM" ? Color.Secondary : 
                              context.GameMode.Contains("URF") ? Color.Warning : Color.Default)">
                @context.GameMode
            </MudChip>
        </MudTd>

        <MudTd DataLabel="Role">
            @if (context.IsSummonersRift)
            {
                <MudTooltip Text="@context.Role">
                    <img src="@LeagueAssetsService.GetRoleIconUrl(context.Role)" 
                         alt="@context.Role" 
                         width="28" 
                         height="28" 
                         style="filter: grayscale(0.2);" /> </MudTooltip>
            }
            else
            {
                <MudText Typo="Typo.caption" Class="text-muted">-</MudText>
            }
        </MudTd>

        <MudTd DataLabel="Champion">
            <div class="d-flex align-center gap-2">
                <img src="@LeagueAssetsService.GetChampionIconUrl(context.Champion)" 
                     height="32" width="32" 
                     style="border-radius: 50%; object-fit: cover;" 
                     alt="@context.Champion" />
                <MudText Typo="Typo.body2" Class="font-weight-bold">@context.Champion</MudText>
            </div>
        </MudTd>

        <MudTd DataLabel="Info">
            <div class="d-flex flex-column gap-1">
                @if (!string.IsNullOrEmpty(context.LaneAlly))
                {
                    <div class="d-flex align-center gap-1" title="Ally">
                         <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Small" Color="Color.Info" />
                         <MudText Typo="Typo.caption">@context.LaneAlly</MudText>
                    </div>
                }
                @if (!string.IsNullOrEmpty(context.LaneEnemy) || !string.IsNullOrEmpty(context.LaneEnemyAlly))
                {
                    <div class="d-flex align-center gap-1" title="Enemies">
                         <MudIcon Icon="@Icons.Material.Filled.Dangerous" Size="Size.Small" Color="Color.Error" />
                         <MudText Typo="Typo.caption">
                             @((!string.IsNullOrEmpty(context.LaneEnemy) ? context.LaneEnemy : "?")) 
                             @if (!string.IsNullOrEmpty(context.LaneEnemyAlly))
                             {
                                 <text>/ @context.LaneEnemyAlly</text>
                             }
                         </MudText>
                    </div>
                }
                @if (string.IsNullOrEmpty(context.LaneAlly) && string.IsNullOrEmpty(context.LaneEnemy))
                {
                    <MudText Typo="Typo.caption" Class="text-muted">-</MudText>
                }
            </div>
        </MudTd>

        <MudTd DataLabel="Division / LP">
            <div class="d-flex flex-column">
                <MudText Typo="Typo.caption" Class="font-weight-bold">@context.CurrentTier @context.CurrentDivision</MudText>
                <MudText Typo="Typo.caption">@context.CurrentLp LP</MudText>
            </div>
        </MudTd>

        <MudTd DataLabel="K/D/A">
            <MudText Class="@GetKdaColor(context)">
                @context.Kills / @context.Deaths / @context.Assists
            </MudText>
        </MudTd>

        <MudTd DataLabel="CS">@context.Cs</MudTd>

        <MudTd DataLabel="Game Length">@context.GameLengthMinutes m</MudTd>

        <MudTd DataLabel="Score">
            <MudTooltip Text="@($"Score: {context.PerformanceScore}/100")">
                <MudChip T="string" Size="Size.Small" 
                         Class="@GetScoreChipClass(context.PerformanceScore)" 
                         Variant="Variant.Filled">
                    @context.PerformanceRating
                </MudChip>
            </MudTooltip>
        </MudTd>

        <MudTd DataLabel="Win">
            <MudChip T="string" Size="Size.Small" Color="@(context.Win ? Color.Success : Color.Error)" Variant="Variant.Filled" Style="min-width: 80px;" Class="justify-center">
                @(context.Win ? "VICTORY" : "DEFEAT")
            </MudChip>
        </MudTd>

        <MudTd DataLabel="Notes">
            @if (!string.IsNullOrEmpty(context.Notes))
            {
                <MudTooltip Text="@context.Notes">
                    <MudIcon Icon="@Icons.Material.Filled.StickyNote2" Size="Size.Small" Color="Color.Info" />
                </MudTooltip>
            }
        </MudTd>

        <MudTd DataLabel="Actions">
            <MudTooltip Text="Edytuj">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" 
                               OnClick="() => OnEdit.InvokeAsync(context)" />
            </MudTooltip>
            <MudTooltip Text="Delete">
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                               OnClick="() => ConfirmDelete(context)" />
            </MudTooltip>
        </MudTd>
    </RowTemplate>
    
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    [Parameter] public List<MatchEntry> Matches { get; set; } = new();
    
    [Parameter] public EventCallback<MatchEntry> OnEdit { get; set; }
    [Parameter] public EventCallback<MatchEntry> OnDelete { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LeagueAssetsService.InitializeAsync();
        StateHasChanged();
    }

    private string GetKdaColor(MatchEntry match)
    {
        var kda = (match.Kills + match.Assists) / Math.Max(1.0, match.Deaths);
        if (kda >= 4.0) return "text-success font-weight-bold";
        if (kda >= 3.0) return "text-info font-weight-bold";
        if (kda < 1.0) return "text-error";
        return "";
    }

    private string GetScoreChipClass(int score) => score switch
    {
        >= 80 => "gradient-success",
        >= 60 => "gradient-primary",
        _ => ""
    };

    private async Task ConfirmDelete(MatchEntry match)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Are you sure you want to delete the match {match.Champion} (KDA: {match.Kills}/{match.Deaths}/{match.Assists})?" },
            { "ButtonText", "Delete" },
            { "Color", Color.Error }
        };

        var dialogRef = await DialogService.ShowAsync<ConfirmDialog>("Confirm", parameters);
        var result = await dialogRef.Result;
        
        if (result is { Canceled: false, Data: true })
        {
            await OnDelete.InvokeAsync(match);
        }
    }
}