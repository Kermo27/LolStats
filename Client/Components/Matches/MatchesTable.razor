@using LolStatsTracker.Shared.Models
@using LolStatsTracker.Services.ChampionService
@inject IChampionService ChampionService
@inject IDialogService DialogService

<MudTable Items="Matches" Hover="true" Bordered="false" Striped="true" Virtualize="true" Class="rounded-xl elevation-3" Dense="true">
    <HeaderContent>
        <MudTh>Data</MudTh>
        <MudTh>Champion</MudTh>
        <MudTh>Role</MudTh> <MudTh>K/D/A</MudTh>
        <MudTh>CS</MudTh>
        <MudTh>Czas</MudTh>
        <MudTh>Wynik</MudTh>
        <MudTh>Akcje</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd DataLabel="Data">
            <MudText Typo="Typo.body2">@context.Date.ToString("dd-MM-yyyy")</MudText>
        </MudTd>

        <MudTd DataLabel="Champion">
            <div class="d-flex align-center gap-2">
                <img src="@ChampionService.GetChampionIconUrl(context.Champion)" 
                     height="32" width="32" 
                     style="border-radius: 50%; object-fit: cover;" 
                     alt="@context.Champion" />
                <MudText Typo="Typo.body2" Class="font-weight-bold">@context.Champion</MudText>
            </div>
        </MudTd>

        <MudTd DataLabel="Role">
            <div class="d-flex flex-column gap-1">
                <div class="d-flex align-center gap-1" title="Twój Support">
                     <MudIcon Icon="@Icons.Material.Filled.Shield" Size="Size.Small" Color="Color.Info" />
                     <MudText Typo="Typo.caption">@context.Support</MudText>
                </div>
                <div class="d-flex align-center gap-1" title="Enemy Bot">
                     <MudIcon Icon="@Icons.Material.Filled.Dangerous" Size="Size.Small" Color="Color.Error" />
                     <MudText Typo="Typo.caption">@context.EnemyBot / @context.EnemySupport</MudText>
                </div>
            </div>
        </MudTd>

        <MudTd DataLabel="K/D/A">
            <MudText Class="@GetKdaColor(context)">
                @context.Kills / @context.Deaths / @context.Assists
            </MudText>
        </MudTd>

        <MudTd DataLabel="CS">@context.Cs</MudTd>

        <MudTd DataLabel="Game Length">@context.GameLengthMinutes m</MudTd>

        <MudTd DataLabel="Win">
            <MudChip T="string" Size="Size.Small" Color="@(context.Win ? Color.Success : Color.Error)" Variant="Variant.Filled">
                @(context.Win ? "VICTORY" : "DEFEAT")
            </MudChip>
        </MudTd>

        <MudTd DataLabel="Akcje">
            <MudTooltip Text="Edytuj">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" 
                               OnClick="() => OnEdit.InvokeAsync(context)" />
            </MudTooltip>
            <MudTooltip Text="Usuń">
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small"
                               OnClick="() => ConfirmDelete(context)" />
            </MudTooltip>
        </MudTd>
    </RowTemplate>
    
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code {
    [Parameter] public List<MatchEntry> Matches { get; set; } = new();
    
    [Parameter] public EventCallback<MatchEntry> OnEdit { get; set; }
    [Parameter] public EventCallback<MatchEntry> OnDelete { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await ChampionService.InitializeAsync();
        StateHasChanged();
    }

    private string GetKdaColor(MatchEntry match)
    {
        var kda = (match.Kills + match.Assists) / Math.Max(1.0, match.Deaths);
        if (kda >= 4.0) return "text-success font-weight-bold";
        if (kda >= 2.5) return "text-info";
        if (kda < 1.0) return "text-error";
        return "";
    }

    private async Task ConfirmDelete(MatchEntry match)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Czy na pewno chcesz usunąć mecz {match.Champion} (KDA: {match.Kills}/{match.Deaths}/{match.Assists})?" },
            { "ButtonText", "Usuń" },
            { "Color", Color.Error }
        };

        var dialogRef = await DialogService.ShowAsync<ConfirmDialog>("Potwierdzenie", parameters);
        var result = await dialogRef.Result;
        
        if (!result.Canceled && result.Data is true)
        {
            await OnDelete.InvokeAsync(match);
        }
    }
}