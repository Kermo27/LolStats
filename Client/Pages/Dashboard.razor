@page "/"
@using LolStatsTracker.Shared.DTOs
@using LolStatsTracker.Services.ChampionService
@using LolStatsTracker.Services.StatsService
@inject IStatsService StatsService
@inject IChampionService ChampionService

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 mb-8">
    
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Class="font-weight-bold">Panel Główny</MudText>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Podsumowanie statystyk</MudText>
        </div>
    </div>

    @if (_stats == null)
    {
        <MudStack AlignItems="AlignItems.Center" Class="mt-10">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
            <MudText>Analizowanie danych...</MudText>
        </MudStack>
    }
    else
    {
        <MudGrid Spacing="3">
            
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="p-4 rounded-xl d-flex flex-column gap-2 align-center justify-center text-center" Elevation="2" Height="100%">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">GLOBALNY WSPÓŁCZYNNIK ZWYCIĘSTW</MudText>
                    <div class="d-flex align-end gap-2 justify-center">
                        <MudText Typo="Typo.h3" Color="@(_stats.Overview.Winrate * 100 >= 50 ? Color.Success : Color.Error)" Class="font-weight-bold">
                            @((_stats.Overview.Winrate * 100).ToString("F1"))%
                        </MudText>
                        <MudText Typo="Typo.body1" Class="mb-1">WR</MudText>
                    </div>
                    <MudDivider Class="my-2"/>
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">NAJWIĘCEJ GRANY</MudText>
                    <div class="d-flex flex-column align-center gap-3">
                        <img src="@ChampionService.GetChampionIconUrl(_stats.Overview.MostPlayedChampion)" 
                             height="48" width="48" 
                             style="border-radius: 50%; object-fit: cover;" />
                        
                        <div>
                            <MudText Typo="Typo.h6">@_stats.Overview.MostPlayedChampion</MudText>
                            <MudText Typo="Typo.caption">@_stats.Overview.MostPlayedChampionGames gier</MudText>
                        </div>
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="p-4 rounded-xl" Elevation="2" Height="100%">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="text-center mb-3">NAJLEPSZA SYNERGIA DUO</MudText>
                    
                    @if (_stats.BestDuos.Any())
                    {
                        var best = _stats.BestDuos.First();
                        <div class="d-flex justify-center align-center gap-4 my-2">
                            <div class="d-flex flex-column align-center">
                                <img src="@ChampionService.GetChampionIconUrl(best.Champion)" 
                                     height="64" width="64" 
                                     style="border-radius: 50%; border: 3px solid var(--mud-palette-primary); object-fit: cover;" />
                                <MudText Typo="Typo.caption" Class="mt-1">@best.Champion</MudText>
                            </div>
                            
                            <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
                            
                            <div class="d-flex flex-column align-center">
                                <img src="@ChampionService.GetChampionIconUrl(best.Support)" 
                                     height="64" width="64" 
                                     style="border-radius: 50%; border: 3px solid var(--mud-palette-info); object-fit: cover;" />
                                <MudText Typo="Typo.caption" Class="mt-1">@best.Support</MudText>
                            </div>
                        </div>
                        <div class="d-flex justify-center mt-2 gap-2">
                            <MudChip T="string" Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">@best.WinRate.ToString("F0")% WR</MudChip>
                            <MudChip T="string" Color="Color.Surface" Variant="Variant.Outlined" Size="Size.Small">@best.Count gier</MudChip>
                        </div>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Brak danych duo.</MudAlert>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="p-4 rounded-xl" Elevation="2" Height="100%">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-4 text-center">ANALIZA STYLU GRY</MudText>
                    
                    <div class="mb-4">
                        <div class="d-flex justify-space-between mb-1">
                            <MudText Typo="Typo.body2">Wsparcie Enchanterami</MudText>
                            <MudText Typo="Typo.body2" Class="font-weight-bold">@_stats.EnchanterUsage.MyPercentage.ToString("F0")%</MudText>
                        </div>
                        <MudProgressLinear Color="Color.Primary" Value="@_stats.EnchanterUsage.MyPercentage" Size="Size.Large" Rounded="true" />
                    </div>

                    <div>
                        <div class="d-flex justify-space-between mb-1">
                            <MudText Typo="Typo.body2">Przeciw Enchanterom</MudText>
                            <MudText Typo="Typo.body2" Class="font-weight-bold">@_stats.EnchanterUsage.EnemyPercentage.ToString("F0")%</MudText>
                        </div>
                        <MudProgressLinear Color="Color.Error" Value="@_stats.EnchanterUsage.EnemyPercentage" Size="Size.Large" Rounded="true" />
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="7">
                <MudPaper Class="p-4 rounded-xl" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Top 5 Najczęściej Granych</MudText>
                    <MudTable Items="_stats.ChampionStats.Take(5)" Hover="true" Dense="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Champion</MudTh>
                            <MudTh>Gry</MudTh>
                            <MudTh>Winrate</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <div class="d-flex align-center gap-2">
                                    <img src="@ChampionService.GetChampionIconUrl(context.ChampionName)" 
                                         height="32" width="32" 
                                         style="border-radius: 50%; object-fit: cover;" />
                                    <MudText>@context.ChampionName</MudText>
                                </div>
                            </MudTd>
                            <MudTd>@context.Games</MudTd>
                            <MudTd>
                                <MudText Color="@(context.Winrate * 100 >= 50 ? Color.Success : Color.Error)" Class="font-weight-bold">
                                    @((context.Winrate * 100).ToString("F0"))%
                                </MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="5">
                <MudPaper Class="p-4 rounded-xl" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Trudni Przeciwnicy (Bot Lane)</MudText>
                    <MudList T="string" Dense="true" DisablePadding="true">
                        @foreach (var enemy in _stats.EnemyBotStats.Take(5))
                        {
                            <MudListItem>
                                <div class="d-flex align-center justify-space-between w-100">
                                    <div class="d-flex align-center gap-2">
                                        <img src="@ChampionService.GetChampionIconUrl(enemy.ChampionName)" 
                                             height="36" width="36" 
                                             style="border-radius: 50%; border: 2px solid var(--mud-palette-error); object-fit: cover;" />
                                        <MudText>@enemy.ChampionName</MudText>
                                    </div>
                                    <div class="text-right">
                                        <MudText Typo="Typo.caption">Przegrane</MudText>
                                        <MudText Color="Color.Error" Class="font-weight-bold">
                                            @((100 - (enemy.WinrateAgainst * 100)).ToString("F0"))%
                                        </MudText>
                                    </div>
                                </div>
                            </MudListItem>
                            <MudDivider Class="my-1"/>
                        }
                    </MudList>
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12">
    <MudPaper Class="p-4 rounded-xl" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-4">Aktywność w ostatnich 90 dniach</MudText>
        
        <div class="d-flex align-center gap-2 mb-3">
            <MudText Typo="Typo.caption" Class="text-muted">Mniej gier</MudText>
            <div style="width: 10px; height: 10px; background-color: #1a1a20; border-radius: 2px;"></div>
            <div style="width: 10px; height: 10px; background-color: var(--mud-palette-primary-lighten); opacity: 0.5; border-radius: 2px;"></div>
            <div style="width: 10px; height: 10px; background-color: var(--mud-palette-primary-lighten); opacity: 0.7; border-radius: 2px;"></div>
            <div style="width: 10px; height: 10px; background-color: var(--mud-palette-primary); border-radius: 2px;"></div>
            <MudText Typo="Typo.caption" Class="text-muted">Więcej gier</MudText>
        </div>

        <div class="d-flex" style="overflow-x: auto; padding-bottom: 10px;">
            
            <div class="d-flex flex-column gap-1 mr-2 pt-3" style="min-width: 30px;">
                @foreach (var day in _Days)
                {
                    <MudText Typo="Typo.caption" Style="height: 15px; display: flex; align-items: center;">@day</MudText>
                }
            </div>
            
            @for (int weekIndex = 0; weekIndex < (90 / 7); weekIndex++)
            {
                <div class="d-flex flex-column gap-1" style="margin-right: 2px;">
                    @for (int dayIndex = 0; dayIndex < 7; dayIndex++)
                    {
                        var dayName = _Days[dayIndex];
                        int dayInMatrixIndex = weekIndex * 7 + dayIndex;
                        
                        // Pobieranie wartości dla komórki
                        var gameCount = _activityMatrix.ContainsKey(dayName) && dayInMatrixIndex < _activityMatrix[dayName].Count 
                            ? _activityMatrix[dayName][dayInMatrixIndex] 
                            : 0;

                        <MudTooltip Text="@($"Gier: {gameCount} (Dzień: {dayName})")">
                            <div style="width: 15px; height: 15px; border-radius: 2px; cursor: pointer; transition: background-color 0.3s;"
                                 class="@GetHeatmapColorClass(gameCount, _maxGamesPerDay)">
                            </div>
                        </MudTooltip>
                    }
                </div>
            }
        </div>
    </MudPaper>
</MudItem>

        </MudGrid>
    }
</MudContainer>

@code {
    private StatsSummaryDto? _stats;
    private Dictionary<string, List<int>> _activityMatrix = new();
    private int _maxGamesPerDay = 0;
    
    private readonly string[] _Days = { "Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun" };

    protected override async Task OnInitializedAsync()
    {
        await ChampionService.InitializeAsync();
        _stats = await StatsService.GetSummaryAsync();

        if (_stats != null)
        {
            PrepareActivityMatrix();
        }
    }

    private void PrepareActivityMatrix()
    {
        var activityData = _stats!.Activity
            .ToDictionary(a => a.Date, a => a.GamesPlayed);
        
        _maxGamesPerDay = activityData.Values.Any() ? activityData.Values.Max() : 0;
        
        const int totalDays = 180;
        var matrixData = new Dictionary<string, List<int>>();
        
        foreach (var day in _Days)
        {
            matrixData.Add(day, new List<int>());
        }
        
        var today = DateTime.Today;
        
        for (int i = totalDays - 1; i >= 0; i--)
        {
            var date = today.AddDays(-i);
            var dayOfWeekIndex = (int)date.DayOfWeek;
            
            var arrayIndex = (dayOfWeekIndex == 0) ? 6 : dayOfWeekIndex - 1; 
            var dayName = _Days[arrayIndex];
            
            var games = activityData.GetValueOrDefault(DateOnly.FromDateTime(date), 0);
            
            matrixData[dayName].Add(games);
        }
        
        _activityMatrix = matrixData; 
    }
    
    private string GetHeatmapColorClass(int gameCount, int maxGames)
    {
        if (maxGames == 0 || gameCount == 0) return "bg-[#1a1a20]";

        double normalized = (double)gameCount / maxGames;
        
        if (normalized >= 0.75) return "bg-primary";
        if (normalized >= 0.5) return "bg-primary-darken";
        if (normalized >= 0.25) return "bg-primary-lighten";
        return "bg-primary-text-light";
    }
}