@page "/"
@using LolStatsTracker.Shared.DTOs
@using LolStatsTracker.Services.LeagueAssetsService
@using LolStatsTracker.Services.MatchService
@using LolStatsTracker.Services.StatsService
@using LolStatsTracker.Services.UserState
@using LolStatsTracker.Shared.Models
@inject IStatsService StatsService
@inject ILeagueAssetsService LeagueAssetsService
@inject IMatchService MatchService
@inject UserProfileState UserState

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 mb-8">
    
    <div class="d-flex justify-space-between align-center mb-6">
        <div>
            <MudText Typo="Typo.h4" Class="font-weight-bold">Dashboard</MudText>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Summary for: @(UserState.CurrentProfile?.Name ?? "...")</MudText>
        </div>
    </div>

    @if (_stats == null)
    {
        <MudStack AlignItems="AlignItems.Center" Class="mt-10">
            <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
            <MudText>Analyzing</MudText>
        </MudStack>
    }
    else
    {
        <MudGrid Spacing="3">
            
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="p-4 rounded-xl d-flex flex-column gap-2 align-center justify-center text-center" Elevation="2" Height="100%">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Overall WinRate</MudText>
                    <div class="d-flex align-end gap-2 justify-center">
                        <MudText Typo="Typo.h3" Color="@(_stats.Overview.Winrate * 100 >= 50 ? Color.Success : Color.Error)" Class="font-weight-bold">
                            @((_stats.Overview.Winrate * 100).ToString("F1"))%
                        </MudText>
                        <MudText Typo="Typo.body1" Class="mb-1">WR</MudText>
                    </div>
                    <MudDivider Class="my-2"/>
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">MOST PLAYED</MudText>
                    <div class="d-flex flex-column align-center gap-3">
                        <img src="@LeagueAssetsService.GetChampionIconUrl(_stats.Overview.MostPlayedChampion)" 
                             height="48" width="48" 
                             style="border-radius: 50%; object-fit: cover;" />
                        
                        <div>
                            <MudText Typo="Typo.h6">@_stats.Overview.MostPlayedChampion</MudText>
                            <MudText Typo="Typo.caption">@_stats.Overview.MostPlayedChampionGames gier</MudText>
                        </div>
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="p-4 rounded-xl" Elevation="2" Height="100%">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="text-center mb-3">BEST DUO</MudText>
                    
                    @if (_stats.BestDuos.Any())
                    {
                        var best = _stats.BestDuos.First();
                        <div class="d-flex justify-center align-center gap-4 my-2">
                            <div class="d-flex flex-column align-center">
                                <img src="@LeagueAssetsService.GetChampionIconUrl(best.Champion)" 
                                     height="64" width="64" 
                                     style="border-radius: 50%; border: 3px solid var(--mud-palette-primary); object-fit: cover;" />
                                <MudText Typo="Typo.caption" Class="mt-1">@best.Champion</MudText>
                            </div>
                            
                            <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" />
                            
                            <div class="d-flex flex-column align-center">
                                <img src="@LeagueAssetsService.GetChampionIconUrl(best.Support)" 
                                     height="64" width="64" 
                                     style="border-radius: 50%; border: 3px solid var(--mud-palette-info); object-fit: cover;" />
                                <MudText Typo="Typo.caption" Class="mt-1">@best.Support</MudText>
                            </div>
                        </div>
                        <div class="d-flex justify-center mt-2 gap-2">
                            <MudChip T="string" Color="Color.Success" Variant="Variant.Filled" Size="Size.Small">@best.WinRate.ToString("F0")% WR</MudChip>
                            <MudChip T="string" Color="Color.Surface" Variant="Variant.Outlined" Size="Size.Small">@best.Count games</MudChip>
                        </div>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Not enough data.</MudAlert>
                    }
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudPaper Class="p-4 rounded-xl" Elevation="2" Height="100%">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-4 text-center">ENCHANTERS</MudText>
                    
                    <div class="mb-4">
                        <div class="d-flex justify-space-between mb-1">
                            <MudText Typo="Typo.body2">My Team</MudText>
                            <MudText Typo="Typo.body2" Class="font-weight-bold">@_stats.EnchanterUsage.MyPercentage.ToString("F0")%</MudText>
                        </div>
                        <MudProgressLinear Color="Color.Primary" Value="@_stats.EnchanterUsage.MyPercentage" Size="Size.Large" Rounded="true" />
                    </div>

                    <div>
                        <div class="d-flex justify-space-between mb-1">
                            <MudText Typo="Typo.body2">Enemy Team</MudText>
                            <MudText Typo="Typo.body2" Class="font-weight-bold">@_stats.EnchanterUsage.EnemyPercentage.ToString("F0")%</MudText>
                        </div>
                        <MudProgressLinear Color="Color.Error" Value="@_stats.EnchanterUsage.EnemyPercentage" Size="Size.Large" Rounded="true" />
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="7">
                <MudPaper Class="p-4 rounded-xl" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">TOP 5 MOST PLAYED</MudText>
                    <MudTable Items="_stats.ChampionStats.Take(5)" Hover="true" Dense="true" Elevation="0">
                        <HeaderContent>
                            <MudTh>Champion</MudTh>
                            <MudTh>Games</MudTh>
                            <MudTh>Winrate</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd>
                                <div class="d-flex align-center gap-2">
                                    <img src="@LeagueAssetsService.GetChampionIconUrl(context.ChampionName)" 
                                         height="32" width="32" 
                                         style="border-radius: 50%; object-fit: cover;" />
                                    <MudText>@context.ChampionName</MudText>
                                </div>
                            </MudTd>
                            <MudTd>@context.Games</MudTd>
                            <MudTd>
                                <MudText Color="@(context.Winrate * 100 >= 50 ? Color.Success : Color.Error)" Class="font-weight-bold">
                                    @((context.Winrate * 100).ToString("F0"))%
                                </MudText>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="5">
                <MudPaper Class="p-4 rounded-xl" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">HARD ENEMY (BOT)</MudText>
                    <MudList T="string" Dense="true" DisablePadding="true">
                        @foreach (var enemy in _stats.EnemyBotStats.Take(5))
                        {
                            <MudListItem>
                                <div class="d-flex align-center justify-space-between w-100">
                                    <div class="d-flex align-center gap-2">
                                        <img src="@LeagueAssetsService.GetChampionIconUrl(enemy.ChampionName)" 
                                             height="36" width="36" 
                                             style="border-radius: 50%; border: 2px solid var(--mud-palette-error); object-fit: cover;" />
                                        <MudText>@enemy.ChampionName</MudText>
                                    </div>
                                    <div class="text-right">
                                        <MudText Typo="Typo.caption">Losses</MudText>
                                        <MudText Color="Color.Error" Class="font-weight-bold">
                                            @((100 - (enemy.WinrateAgainst * 100)).ToString("F0"))%
                                        </MudText>
                                    </div>
                                </div>
                            </MudListItem>
                            <MudDivider Class="my-1"/>
                        }
                    </MudList>
                </MudPaper>
            </MudItem>
            
            <MudItem xs="12">
                <MudPaper Class="p-4 rounded-xl" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Activity Matrix</MudText>
                    
                    <div class="d-flex align-center gap-2 mb-3">
                        <MudText Typo="Typo.caption" Class="text-muted">Less</MudText>
                        <div style="width: 10px; height: 10px; background-color: #282830; border-radius: 2px;"></div>
                        <div style="width: 10px; height: 10px; background-color: #3f3c6e; border-radius: 2px;"></div>
                        <div style="width: 10px; height: 10px; background-color: #594ae2; border-radius: 2px;"></div>
                        <MudText Typo="Typo.caption" Class="text-muted">More</MudText>
                    </div>

                    <div class="d-flex" style="overflow-x: auto; padding-bottom: 10px;">
                        
                        <div class="d-flex flex-column gap-1 mr-2 pt-0" style="min-width: 30px; margin-top: 2px;">
                            <MudText Typo="Typo.caption" Style="height: 12px; font-size: 10px; line-height: 12px;">Mon</MudText>
                            <div style="height: 12px;"></div>
                            <MudText Typo="Typo.caption" Style="height: 12px; font-size: 10px; line-height: 12px;">Tue</MudText>
                            <div style="height: 12px;"></div>
                            <MudText Typo="Typo.caption" Style="height: 12px; font-size: 10px; line-height: 12px;">Fri</MudText>
                            <div style="height: 12px;"></div>
                            <MudText Typo="Typo.caption" Style="height: 12px; font-size: 10px; line-height: 12px;">Sun</MudText>
                        </div>
                        
                        @foreach (var week in _matrix)
                        {
                            <div class="d-flex flex-column gap-1" style="margin-right: 3px;">
                                @foreach (var day in week)
                                {
                                    <MudTooltip Text="@($"{day.Date:dd.MM.yyyy}\n{day.Count} games")" 
                                                Style="white-space: pre-wrap; text-align: center;" 
                                                Arrow="true" 
                                                Placement="Placement.Top"
                                                Delay="0">
                                        
                                        <div style="@($"width: 12px; height: 12px; border-radius: 2px; background-color: {GetHeatmapColor(day.Count)}; transition: opacity 0.2s;")"
                                             class="heatmap-square">
                                        </div>
                                    </MudTooltip>
                                }
                            </div>
                        }
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                <MudPaper Class="p-4 rounded-xl" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">LP Trend (20 last games)</MudText>
                    <MudChart ChartType="ChartType.Line" ChartSeries="@_lpSeries" XAxisLabels="@_lpLabels" Width="100%" Height="300px" ChartOptions="@(new ChartOptions { InterpolationOption = InterpolationOption.Straight })" />
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

<style>
    .heatmap-square:hover {
        opacity: 0.7;
        border: 1px solid white;
    }
</style>

@code {
    private StatsSummaryDto? _stats;
    
    private List<List<(DateTime Date, int Count)>> _matrix = new();
    
    private int _maxGamesPerDay = 0;
    private List<ChartSeries> _lpSeries = new();
    private string[] _lpLabels = Array.Empty<string>();

    protected override async Task OnInitializedAsync()
    {
        await LeagueAssetsService.InitializeAsync();
        
        if (!UserState.IsInitialized) await UserState.InitializeAsync();
        
        if (UserState.CurrentProfile == null)
        {
            Console.WriteLine("Dashboard: Brak wybranego profilu. Przerywam ładowanie danych.");
            return;
        }
        
        _stats = await StatsService.GetSummaryAsync();
        var matches = (await MatchService.GetAllAsync()).OrderBy(m => m.Date).TakeLast(20).ToList();
        
        if (_stats != null)
        {
            PrepareActivityMatrix();
            PrepareLpChart(matches);
        }
    }

    private void PrepareActivityMatrix()
    {
        var builder = new ActivityMatrixBuilder(_stats!.Activity);
        _matrix = builder.Build();
        
        _maxGamesPerDay = _stats.Activity.Any() ? _stats.Activity.Max(x => x.GamesPlayed) : 1; 
    }
    
    private string GetHeatmapColor(int gameCount)
    {
        if (gameCount == 0) return "#282830"; 

        var normalized = (double)gameCount / _maxGamesPerDay;

        return normalized switch
        {
            >= 0.75 => "#594ae2",
            >= 0.40 => "#4840b0",
            _ => "#3f3c6e"
        };
    }
    
    private void PrepareLpChart(List<MatchEntry> matches)
    {
        var data = new List<double>();
        double currentNet = 0;
        var labels = new List<string>();

        var i = 1;
        foreach (var m in matches)
        {
            currentNet += m.LpChange;
            data.Add(currentNet);
            labels.Add(i++.ToString());
        }

        _lpSeries.Add(new ChartSeries { Name = "Net LP Change", Data = data.ToArray() });
        _lpLabels = labels.ToArray();
    }
}