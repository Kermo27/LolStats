@page "/timeline"
@using LolStatsTracker.Shared.Models
@using LolStatsTracker.Services.LeagueAssetsService
@using LolStatsTracker.Services.MatchService
@using LolStatsTracker.Services.SeasonState
@using LolStatsTracker.Services.UserState
@inject ILeagueAssetsService LeagueAssetsService
@inject IMatchService MatchService
@inject UserProfileState UserState
@inject SeasonState SeasonState

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-6 mb-8">
    <div class="page-header d-flex align-center gap-4">
        <div class="icon-badge">
            <MudIcon Icon="@Icons.Material.Filled.Timeline" Size="Size.Medium" Color="Color.Surface" />
        </div>
        <div>
            <MudText Typo="Typo.h4" Class="font-weight-bold">Performance Timeline</MudText>
            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">Game-by-game history with performance scores</MudText>
        </div>
    </div>

    @if (_isLoading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="rounded-lg" />
    }
    else if (!_matches.Any())
    {
        <MudAlert Severity="Severity.Info" Class="rounded-xl">No matches recorded yet.</MudAlert>
    }
    else
    {
        <MudPaper Class="rounded-xl glass-card mb-4">
            <div class="d-flex gap-4 flex-wrap align-center">
                <MudSelect T="string" @bind-Value="_championFilter" Label="Champion" Variant="Variant.Outlined" Clearable="true" Dense="true" Style="min-width: 150px;">
                    @foreach (var champ in _champions)
                    {
                        <MudSelectItem Value="@champ">@champ</MudSelectItem>
                    }
                </MudSelect>
                
                <MudSelect T="string" @bind-Value="_resultFilter" Label="Result" Variant="Variant.Outlined" Clearable="true" Dense="true" Style="min-width: 120px;">
                    <MudSelectItem Value="@("Win")">Wins Only</MudSelectItem>
                    <MudSelectItem Value="@("Loss")">Losses Only</MudSelectItem>
                </MudSelect>
                
                <MudNumericField T="int" @bind-Value="_minScore" Label="Min Score" Variant="Variant.Outlined" Min="0" Max="100" Style="width: 100px;" />
                
                <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="ClearFilters">Clear</MudButton>
            </div>
        </MudPaper>

        <MudTimeline TimelinePosition="TimelinePosition.Start">
            @foreach (var match in FilteredMatches.Take(50))
            {
                <MudTimelineItem Color="@(match.Win ? Color.Success : Color.Error)" 
                                 Size="Size.Medium"
                                 Elevation="0">
                    <ItemOpposite>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@match.Date.ToString("MMM dd")</MudText>
                        <MudText Typo="Typo.caption">@match.Date.ToString("HH:mm")</MudText>
                    </ItemOpposite>
                    <ItemContent>
                        <MudPaper Class="rounded-xl glass-card" Elevation="0">
                            <div class="d-flex align-center gap-3 flex-wrap">
                                <img src="@LeagueAssetsService.GetChampionIconUrl(match.Champion)" 
                                     height="48" width="48" 
                                     style="border-radius: 50%; border: 3px solid @(match.Win ? "var(--mud-palette-success)" : "var(--mud-palette-error)");" />
                                
                                <div class="flex-grow-1">
                                    <div class="d-flex align-center gap-2">
                                        <MudText Typo="Typo.h6" Class="font-weight-bold">@match.Champion</MudText>
                                        <MudChip T="string" Size="Size.Small" 
                                                 Class="@(match.Win ? "victory-badge" : "defeat-badge")">
                                            @(match.Win ? "WIN" : "LOSS")
                                        </MudChip>
                                        <MudChip T="string" Size="Size.Small" 
                                                 Class="@GetScoreClass(match.PerformanceScore)"
                                                 Variant="Variant.Filled">
                                            @match.PerformanceRating (@match.PerformanceScore)
                                        </MudChip>
                                    </div>
                                    <div class="d-flex gap-3 mt-1">
                                        <MudText Typo="Typo.body2">
                                            <span class="kda-kills">@match.Kills</span>/<span class="kda-deaths">@match.Deaths</span>/<span class="kda-assists">@match.Assists</span>
                                        </MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@match.Cs CS ‚Ä¢ @match.GameLengthMinutes min</MudText>
                                        <MudText Typo="Typo.body2" Color="@(match.LpChange >= 0 ? Color.Success : Color.Error)">
                                            @(match.LpChange > 0 ? "+" : "")@match.LpChange LP
                                        </MudText>
                                    </div>
                                    @if (!string.IsNullOrEmpty(match.Notes))
                                    {
                                        <MudText Typo="Typo.caption" Color="Color.Info" Class="mt-1">
                                            üìù @match.Notes
                                        </MudText>
                                    }
                                </div>
                            </div>
                        </MudPaper>
                    </ItemContent>
                </MudTimelineItem>
            }
        </MudTimeline>
        
        @if (FilteredMatches.Count() > 50)
        {
            <MudText Typo="Typo.caption" Color="Color.Secondary" Class="text-center mt-4">
                Showing 50 of @FilteredMatches.Count() matches
            </MudText>
        }
    }
</MudContainer>

@code {
    private bool _isLoading = true;
    private List<MatchEntry> _matches = new();
    private List<string> _champions = new();
    private string? _championFilter;
    private string? _resultFilter;
    private int _minScore = 0;

    protected override async Task OnInitializedAsync()
    {
        await LeagueAssetsService.InitializeAsync();
        if (!UserState.IsInitialized) await UserState.InitializeAsync();
        if (!SeasonState.IsInitialized) await SeasonState.InitializeAsync();
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _isLoading = true;
        var allMatches = await MatchService.GetAllAsync();
        _matches = allMatches
            .Where(m => SeasonState.IsDateInCurrentSeason(m.Date))
            .OrderByDescending(m => m.Date)
            .ToList();
        _champions = _matches.Select(m => m.Champion).Distinct().OrderBy(c => c).ToList();
        _isLoading = false;
    }

    private IEnumerable<MatchEntry> FilteredMatches => _matches
        .Where(m => string.IsNullOrEmpty(_championFilter) || m.Champion == _championFilter)
        .Where(m => string.IsNullOrEmpty(_resultFilter) || (_resultFilter == "Win" ? m.Win : !m.Win))
        .Where(m => m.PerformanceScore >= _minScore);

    private void ClearFilters()
    {
        _championFilter = null;
        _resultFilter = null;
        _minScore = 0;
    }

    private string GetScoreClass(int score) => score switch
    {
        >= 80 => "gradient-success",
        >= 60 => "gradient-primary",
        _ => ""
    };
}
