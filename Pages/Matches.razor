@page "/matches"
@using System.Text.Json
@using LolStatsTracker.Components
@using LolStatsTracker.Services
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<MudPaper Class="p-6 min-h-screen">

    <MudText Typo="Typo.h3" Class="mb-6" Color="Color.Primary">LoL Stats Tracker</MudText>

    <!-- Form -->
    <MudCard Class="mb-8 p-4">
        <MudCardContent>
            <MudText Typo="Typo.h6">@((isEditing ? "Edytuj Mecz" : "Dodaj Mecz"))</MudText>
            <MudGrid Spacing="3">

                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="string"
                                     @bind-Value="currentMatch.Champion"
                                     Label="Champion"
                                     Required="true"
                                     CoerceText="true"
                                     Clearable="true"
                                     SearchFunc="SearchChampions"
                                     ToStringFunc="c => c" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="string"
                                     @bind-Value="currentMatch.Support"
                                     Label="Support"
                                     Required="true"
                                     CoerceText="true"
                                     Clearable="true"
                                     SearchFunc="SearchChampions"
                                     ToStringFunc="c => c" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="string"
                                     @bind-Value="currentMatch.EnemyBot"
                                     Label="Enemy Bot"
                                     Required="true"
                                     CoerceText="true"
                                     Clearable="true"
                                     SearchFunc="SearchChampions"
                                     ToStringFunc="c => c" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudAutocomplete T="string"
                                     @bind-Value="currentMatch.EnemySupport"
                                     Label="Enemy Support"
                                     Required="true"
                                     CoerceText="true"
                                     Clearable="true"
                                     SearchFunc="SearchChampions"
                                     ToStringFunc="c => c" />
                </MudItem>

                <MudItem xs="12" sm="4">
                    <MudNumericField @bind-Value="currentMatch.Kills" Label="Kills" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudNumericField @bind-Value="currentMatch.Deaths" Label="Deaths" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudNumericField @bind-Value="currentMatch.Assists" Label="Assists" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="currentMatch.Cs" Label="CS" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="currentMatch.GameLengthMinutes" Label="Game Length (min)" />
                </MudItem>
                
                <MudItem xs="12" sm="6">
                    <MudDatePicker @bind-Date="currentMatch.Date" Label="Data meczu" DateFormat="dd-MM-yyyy" />
                </MudItem>

                <MudItem xs="12">
                    <MudCheckBox @bind-Checked="currentMatch.Win" T="bool" Label="Win?" />
                </MudItem>

                <MudItem xs="12" Class="mt-2">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SubmitMatch">
                        @(isEditing ? "Zapisz zmiany" : "Dodaj mecz")
                    </MudButton>
                    @if(isEditing)
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Class="ml-2" OnClick="CancelEdit">
                            Anuluj
                        </MudButton>
                    }
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <!-- Actions -->
    <MudStack Direction="Row" Spacing="2" Class="mb-4">
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="ExportJson">Eksportuj JSON</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="TriggerImport">Import JSON</MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="ClearData">Usuń wszystkie</MudButton>
        <InputFile id="fileInput" OnChange="ImportJson" style="display:none" />
    </MudStack>

    <!-- Table -->
    <MudTable Items="matches" Hover="true" Bordered="true" Striped="true">
        <HeaderContent>
            <MudTh>Date</MudTh>
            <MudTh>Champion</MudTh>
            <MudTh>Support</MudTh>
            <MudTh>Enemy Bot</MudTh>
            <MudTh>Enemy Support</MudTh>
            <MudTh>K/D/A</MudTh>
            <MudTh>CS</MudTh>
            <MudTh>Game Length</MudTh>
            <MudTh>Win</MudTh>
            <MudTh>Akcje</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Date">@context.Date?.ToString("dd-MM-yyyy")</MudTd>
            <MudTd DataLabel="Champion">@context.Champion</MudTd>
            <MudTd DataLabel="Support">@context.Support</MudTd>
            <MudTd DataLabel="Enemy Bot">@context.EnemyBot</MudTd>
            <MudTd DataLabel="Enemy Support">@context.EnemySupport</MudTd>
            <MudTd DataLabel="K/D/A">@context.Kills/@context.Deaths/@context.Assists</MudTd>
            <MudTd DataLabel="CS">@context.Cs</MudTd>
            <MudTd DataLabel="Game Length">@context.GameLengthMinutes</MudTd>
            <MudTd DataLabel="Win">@((context.Win) ? "✔️" : "❌")</MudTd>
            <MudTd DataLabel="Akcje">
                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="() => StartEdit(context)"/>
                <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                               OnClick="async () => await DeleteMatch(context)" />
            </MudTd>
        </RowTemplate>
    </MudTable>

</MudPaper>

@code {
    private MatchService matchService = default!;
    private MatchEntry currentMatch = new();
    private List<MatchEntry> matches = new();
    private bool isEditing = false;

    private InputFile? fileInput;

    protected override async Task OnInitializedAsync()
    {
        var storage = new LocalStorageService(JS);
        matchService = new MatchService(storage);
        await matchService.InitializeAsync();
        await RefreshMatches();
    }

    private async Task RefreshMatches() => matches = matchService.GetAll().OrderByDescending(m => m.Date).ToList();

    private async Task SubmitMatch()
    {
        if(isEditing)
        {
            await matchService.UpdateMatchAsync(currentMatch);
            Snackbar.Add("Mecz zaktualizowany", Severity.Success);
        }
        else
        {
            await matchService.AddMatchAsync(currentMatch);
            Snackbar.Add("Mecz dodany", Severity.Success);
        }
        ResetForm();
        await RefreshMatches();
    }

    private void StartEdit(MatchEntry match)
    {
        currentMatch = new MatchEntry
        {
            Id = match.Id,
            Champion = match.Champion,
            Support = match.Support,
            EnemyBot = match.EnemyBot,
            EnemySupport = match.EnemySupport,
            Kills = match.Kills,
            Deaths = match.Deaths,
            Assists = match.Assists,
            Cs = match.Cs,
            GameLengthMinutes = match.GameLengthMinutes,
            Date = match.Date,
            Win = match.Win
        };
        isEditing = true;
    }

    private void CancelEdit() => ResetForm();

    private void ResetForm()
    {
        currentMatch = new MatchEntry();
        isEditing = false;
    }

    private async Task DeleteMatch(MatchEntry match)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Czy na pewno chcesz usunąć mecz {match.Champion}?" },
            { "ButtonText", "Usuń" },
            { "Color", Color.Error }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };

        // ShowAsync zwraca IDialogReference
        var dialogRef = DialogService.ShowAsync<ConfirmDialog>("Potwierdzenie", parameters, options);

        // Czekamy na wynik
        var dialogResult = await dialogRef.Result;

        // Teraz dialogResult ma właściwość Data
        if (dialogResult.Cancelled)
            return;

        if (dialogResult.Data is true)
        {
            await matchService.RemoveMatchAsync(match);
            await RefreshMatches();
            Snackbar.Add("Mecz usunięty", Severity.Success);
        }
    }
    
    private async Task ExportJson()
    {
        var json = JsonSerializer.Serialize(matchService.GetAll(), new JsonSerializerOptions { WriteIndented = true });
        var bytes = System.Text.Encoding.UTF8.GetBytes(json);
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFile", "matches.json", "application/json", base64);
        Snackbar.Add("Dane wyeksportowane", Severity.Info);
    }

    private async Task TriggerImport()
    {
        await JS.InvokeVoidAsync("triggerFileInput", "fileInput");
    }

    private async Task ImportJson(InputFileChangeEventArgs e)
    {
        using var stream = e.File.OpenReadStream(10_000_000);
        using var reader = new StreamReader(stream);
        var json = await reader.ReadToEndAsync();
        var imported = JsonSerializer.Deserialize<List<MatchEntry>>(json, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

        if(imported is null || !imported.Any()) return;

        foreach(var match in imported)
        {
            if(match.Id == Guid.Empty) match.Id = Guid.NewGuid();
            if(!matches.Any(m => m.Id == match.Id)) await matchService.AddMatchAsync(match);
        }

        await RefreshMatches();
        Snackbar.Add($"Zaimportowano {imported.Count} meczy", Severity.Success);
    }

    private async Task ClearData()
    {
        bool confirmed = await JS.InvokeAsync<bool>("confirm", "Czy na pewno usunąć wszystkie dane?");
        if(!confirmed) return;

        await matchService.ClearAsync();
        await RefreshMatches();
        Snackbar.Add("Wszystkie dane usunięte", Severity.Success);
    }
    
    private Task<IEnumerable<string>> SearchChampions(string value, CancellationToken cancellationToken)
    {
        if (string.IsNullOrWhiteSpace(value))
            return Task.FromResult(ChampionList.Names.AsEnumerable());

        var filtered = ChampionList.Names
            .Where(c => c.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Take(8);

        return Task.FromResult(filtered);
    }
}
