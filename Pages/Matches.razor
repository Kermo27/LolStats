@page "/matches"
@using System.Text.Json
@using LolStatsTracker.Components.Matches
@using LolStatsTracker.Models
@using LolStatsTracker.Services

<div class="min-h-screen bg-[#0f0f13] text-gray-200 p-6">
    <h1 class="text-3xl font-bold mb-6 text-blue-400 drop-shadow">LoL Stats Tracker</h1>

    <div class="mb-8">
        <MatchForm Match="currentMatch"
                   OnSubmit="HandleMatchSubmit"
                   OnCancel="HandleCancelEdit"
                   IsEditing="isEditing" />
    </div>

    <div class="mb-8">
        <MatchActions OnExport="ExportJson"
                      OnImport="ImportJson"
                      OnClear="ClearData" />
    </div>

    <NotificationBar ErrorMessage="@errorMessage"
                     OnErrorCleared="() => errorMessage = string.Empty"
                     SuccessMessage="@successMessage"
                     OnSuccessCleared="() => successMessage = string.Empty" />

    <MatchTable Matches="matches"
                IsLoading="isLoading"
                OnEdit="StartEdit"
                OnDelete="DeleteMatch" />
</div>

@code {
    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private MatchService matchService = default!;
    private MatchEntry currentMatch = new();
    private List<MatchEntry> matches = new();
    private bool isLoading = true;
    private bool isEditing = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var storage = new LocalStorageService(JS);
            matchService = new MatchService(storage);
            await matchService.InitializeAsync();
            await RefreshMatches();
        }
        catch (Exception ex)
        {
            errorMessage = $"Błąd inicjalizacji: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RefreshMatches()
    {
        matches = matchService.GetAll().OrderByDescending(m => m.Date).ToList();
    }

    private async Task HandleMatchSubmit(MatchEntry match)
    {
        try
        {
            if (isEditing)
            {
                await matchService.UpdateMatchAsync(match);
                successMessage = "Mecz zaktualizowany pomyślnie!";
            }
            else
            {
                await matchService.AddMatchAsync(match);
                successMessage = "Mecz dodany pomyślnie!";
            }

            await RefreshMatches();
            ResetForm();
            errorMessage = string.Empty;
        }
        catch (Exception ex)
        {
            errorMessage = $"Błąd podczas zapisywania: {ex.Message}";
        }
    }

    private void StartEdit(MatchEntry match)
    {
        currentMatch = new MatchEntry
        {
            Id = match.Id,
            Champion = match.Champion,
            Support = match.Support,
            EnemyBot = match.EnemyBot,
            EnemySupport = match.EnemySupport,
            Kills = match.Kills,
            Deaths = match.Deaths,
            Assists = match.Assists,
            Cs = match.Cs,
            GameLengthMinutes = match.GameLengthMinutes,
            Date = match.Date,
            Win = match.Win
        };
        isEditing = true;
        successMessage = "Tryb edycji - zmień dane i zapisz";
    }

    private void HandleCancelEdit()
    {
        ResetForm();
        successMessage = string.Empty;
    }

    private void ResetForm()
    {
        currentMatch = new MatchEntry();
        isEditing = false;
    }

    private async Task DeleteMatch(MatchEntry match)
    {
        try
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm", 
                $"Usunąć mecz z {match.Date:yyyy-MM-dd} ({match.Champion})?");
            if (!confirmed) return;

            await matchService.RemoveMatchAsync(match);
            await RefreshMatches();
            successMessage = "Mecz usunięty pomyślnie!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Błąd podczas usuwania: {ex.Message}";
        }
    }

    private async Task ExportJson()
    {
        try
        {
            var json = JsonSerializer.Serialize(matchService.GetAll(), 
                new JsonSerializerOptions { WriteIndented = true });
            var bytes = System.Text.Encoding.UTF8.GetBytes(json);
            var base64 = Convert.ToBase64String(bytes);
            await JS.InvokeVoidAsync("downloadFile", "matches.json", "application/json", base64);
            successMessage = "Dane wyeksportowane pomyślnie!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Błąd eksportu: {ex.Message}";
        }
    }

    private async Task ImportJson(InputFileChangeEventArgs e)
    {
        try
        {
            if (e.File is null) return;

            using var stream = e.File.OpenReadStream(10_000_000);
            using var reader = new StreamReader(stream);
            var json = await reader.ReadToEndAsync();
            var imported = JsonSerializer.Deserialize<List<MatchEntry>>(json, 
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (imported is null || !imported.Any())
            {
                errorMessage = "Plik jest pusty lub nieprawidłowy";
                return;
            }

            int addedCount = 0;
            foreach (var match in imported)
            {
                if (match.Id == Guid.Empty) match.Id = Guid.NewGuid();
                if (!matches.Any(m => m.Id == match.Id))
                {
                    await matchService.AddMatchAsync(match);
                    addedCount++;
                }
            }

            await RefreshMatches();
            successMessage = $"Zaimportowano {addedCount} meczy!";
        }
        catch (JsonException)
        {
            errorMessage = "Nieprawidłowy format pliku JSON";
        }
        catch (Exception ex)
        {
            errorMessage = $"Błąd importu: {ex.Message}";
        }
    }

    private async Task ClearData()
    {
        try
        {
            var confirmed = await JS.InvokeAsync<bool>("confirm", 
                "Czy na pewno chcesz usunąć wszystkie dane? Tej operacji nie można cofnąć!");
            if (!confirmed) return;

            await matchService.ClearAsync();
            await RefreshMatches();
            successMessage = "Wszystkie dane zostały usunięte";
        }
        catch (Exception ex)
        {
            errorMessage = $"Błąd podczas usuwania: {ex.Message}";
        }
    }
}